#!/usr/bin/env php
<?php

if (empty($argv[1])) {
    echo 'You need to specify build target.' . PHP_EOL;

    exit(1);
}

/**
 * Inits autoload. In case composer autoload is not found, will be able
 * to load Konstrui\ classes on its own.
 */
function init_autoload()
{
    $autoloadLookupPaths = [
        __DIR__ . '/vendor/autoload.php',
        __DIR__ . '/../vendor/autoload.php',
        __DIR__ . '/../../vendor/autoload.php',
    ];

    foreach ($autoloadLookupPaths as $path) {
        if (file_exists($path)) {
            require $path;

            return;
        }
    }

    spl_autoload_register(function ($className) {
        $className = ltrim($className, '\\');
        $path = __DIR__ . '/../src/' . str_replace(
            '\\',
            DIRECTORY_SEPARATOR,
            $className
        ) . '.php';

        require $path;
    });
}

init_autoload();

if (file_exists(\Konstrui\Definition\Provider\PhpProvider::PHP_BUILD_FILE)) {
    $phpProvider = new \Konstrui\Definition\Provider\PhpProvider(
        require \Konstrui\Definition\Provider\PhpProvider::PHP_BUILD_FILE
    );
    $resolver = new \Konstrui\Resolver\Resolver($phpProvider->provideDefinition());
    $runner = new \Konstrui\Runner\Runner($resolver, new \Konstrui\Logger\StandardLogger());

    $runner->run(new \Konstrui\Task\TaskAlias($argv[1]));
} else {
    echo 'No build file found.' . PHP_EOL;

    exit(1);
}
