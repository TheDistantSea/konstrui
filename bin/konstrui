#!/usr/bin/env php
<?php

if (empty($argv[1])) {
    echo 'You need to specify build target.' . PHP_EOL;

    exit(1);
}

$autoloadLookupPaths = [
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../vendor/autoload.php',
];

foreach ($autoloadLookupPaths as $path) {
    if (file_exists($path)) {
        require $path;

        break;
    }
}

if (file_exists(\Konstrui\Definition\Provider\PhpProvider::PHP_BUILD_FILE)) {
    $monolog = new Monolog\Logger('output');
    $handler = new Monolog\Handler\StreamHandler('php://stdout');
    $handler->setFormatter(new \Monolog\Formatter\LineFormatter(null, null, false, true));
    $monolog->setHandlers([$handler]);
    $logger = new \Konstrui\Logger\MonologLoggerAdapter($monolog);

    $phpProvider = new \Konstrui\Definition\Provider\PhpProvider(
        require \Konstrui\Definition\Provider\PhpProvider::PHP_BUILD_FILE
    );
    $resolver = new \Konstrui\Resolver\Resolver($phpProvider->provideDefinition());
    $runner = new \Konstrui\Runner\Runner($resolver, $logger);

    $runner->run(new \Konstrui\Task\TaskAlias($argv[1]));
} else {
    echo 'No build file found.' . PHP_EOL;

    exit(1);
}
